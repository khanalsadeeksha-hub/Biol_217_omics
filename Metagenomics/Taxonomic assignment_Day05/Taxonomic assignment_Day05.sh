#!/bin/bash
#SBATCH --nodes=1
#SBATCH --cpus-per-task=20
#SBATCH --mem=60G
#SBATCH --time=12:00:00
#SBATCH --job-name=day5_taxonomy
#SBATCH --output=day5_taxonomy.out
#SBATCH --error=day5_taxonomy.err
#SBATCH --partition=base
#SBATCH --reservation=biol217

# ------------------------------------------------------------------------------
# 1. Environment Setup
# ------------------------------------------------------------------------------
# Activate the conda/micromamba environment
module load gcc12-env/12.1.0
module load micromamba/1.3.1
eval "$(micromamba shell hook --shell=bash)"
export MAMBA_ROOT_PREFIX=$WORK/.micromamba

cd /work_beegfs/sunamNNN/metagenomics # CHANGE 'sunamNNN' TO YOUR ACTUAL USERNAME
micromamba activate 00_anvio

# Define directories based on previous days
WORK_DIR=$(pwd)
CONTIGS_DB="$WORK_DIR/6_anvio_profiles/contigs.db"
PROFILE_DB="$WORK_DIR/6_anvio_profiles/merged_profiles/PROFILE.db"
SUMMARY_OLD="$WORK_DIR/7_binning/SUMMARY_METABAT2"
SUMMARY_FINAL="$WORK_DIR/8_final_summary/SUMMARY_METABAT2_FINAL"
DEREP_DIR="$WORK_DIR/9_dereplication"

mkdir -p $WORK_DIR/8_final_summary $DEREP_DIR

echo "Starting Day 5 Workflow: Taxonomic Assignment & Dereplication..."

# ------------------------------------------------------------------------------
# 2. Taxonomic Assignment
# ------------------------------------------------------------------------------
echo "Running SCG Taxonomy..."
# This step associates the single-copy core genes in your contigs-db with taxonomy information.
anvi-run-scg-taxonomy -c $CONTIGS_DB -T 20 -P 2

echo "Estimating SCG Taxonomy..."
# This program makes quick taxonomy estimates for genomes, metagenomes, or bins stored in your contigs-db using single-copy core genes.
anvi-estimate-scg-taxonomy -c $CONTIGS_DB \
                           -p $PROFILE_DB \
                           --metagenome-mode \
                           --compute-scg-coverages \
                           --update-profile-db-with-taxonomy > $WORK_DIR/8_final_summary/taxonomy_estimation_temp.txt

echo "Generating Final Summary..."
# ONE final summary to get comprehensive info about your METABAT2 bins.
anvi-summarize -p $PROFILE_DB -c $CONTIGS_DB -o $SUMMARY_FINAL -C METABAT2

# ------------------------------------------------------------------------------
# 3. Genome Dereplication (BONUS)
# ------------------------------------------------------------------------------
echo "Preparing tab-delimited file for dereplication..."
# anvi-dereplicate-genome uses the user’s similarity metric of choice to identify genomes that are highly similar to each other, and groups them together into redundant clusters.

GENOMES_TXT="$DEREP_DIR/genomes.txt"

# Programmatically generate the required tab-delimited text file.
# We extract the bin names directly from the bins_summary.txt generated by anvi-summarize.
echo -e "name\tbin_id\tcollection_id\tprofile_db_path\tcontigs_db_path" > $GENOMES_TXT

# Skip the header of bins_summary.txt, grab the first column (bin names), and format it.
tail -n +2 $SUMMARY_OLD/bins_summary.txt | awk -F'\t' '{print $1}' | while read BIN_ID; do
    echo -e "${BIN_ID}\t${BIN_ID}\tMETABAT2\t${PROFILE_DB}\t${CONTIGS_DB}" >> $GENOMES_TXT
done

echo "Running Dereplication at 95%, 90%, and 80% thresholds..."
# It will use fastANI by Jain et al. to perform the dereplication.

# Run at 95% threshold
anvi-dereplicate-genomes -i $GENOMES_TXT \
                         --program fastANI \
                         --similarity-threshold 0.95 \
                         -o $DEREP_DIR/ANI_95 \
                         --log-file $DEREP_DIR/log_ANI_95 \
                         -T 10

# Try to dereplicate again at 90% identity
anvi-dereplicate-genomes -i $GENOMES_TXT \
                         --program fastANI \
                         --similarity-threshold 0.90 \
                         -o $DEREP_DIR/ANI_90 \
                         --log-file $DEREP_DIR/log_ANI_90 \
                         -T 10

# Try to dereplicate again at 80% identity
anvi-dereplicate-genomes -i $GENOMES_TXT \
                         --program fastANI \
                         --similarity-threshold 0.80 \
                         -o $DEREP_DIR/ANI_80 \
                         --log-file $DEREP_DIR/log_ANI_80 \
                         -T 10



echo "Day 5 Pipeline Complete!"
echo "Check $SUMMARY_FINAL/index.html to review your taxonomic assignments and MIMAG quality tiers."